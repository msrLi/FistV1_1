
#include"I2C_IO.h"
/*
*********************************************************************************************************
*
*	?¡ê?¨¦??3? : I2C¡Á¨¹???y?¡¥?¡ê?¨¦
*	???t??3? : bsp_i2c_gpio.c
*	¡ã?    ¡À? : V1.0
*	?¦Ì    ?¡Â : ¨®?gpio?¡ê?ai2c¡Á¨¹??, ¨º¨º¨®?¨®¨²STM32F4?¦Ì¨¢DCPU?¡ê???¡ê?¨¦2?¡ã¨¹¨¤¡§¨®|¨®?2??¨¹¨¢???¡ê???¡ã¨¹¨¤¡§I2C¡Á¨¹???¨´¡À?2¨´¡Á¡Âo¡¥¨ºy?¡ê
*
*	DT?????? :
*		¡ã?¡À?o?  ¨¨??¨²        ¡Á¡Â??     ?¦Ì?¡Â
*		V1.0    2013-02-01 armfly  ?y¨º?¡¤¡é2?
*
*	Copyright (C), 2013-2014, ¡ã2??¨¤3¦Ì?¡Á¨® www.armfly.com
*
*********************************************************************************************************
*/

/*
	¨®|¨®??¦Ì?¡Â¡êo
	?¨²¡¤??¨ºI2C¨¦¨¨¡À??¡ã¡ê????¨¨¦Ì¡Â¨®? i2c_CheckDevice() ?¨¬2aI2C¨¦¨¨¡À?¨º?¡¤??y3¡ê¡ê???o¡¥¨ºy?¨¢????GPIO
*/


/*
	¡ã2??¨¤3STM32-V5?a¡¤¡é¡ã? i2c¡Á¨¹??GPIO:
 		PH4/I2C2_SCL
 		PH5/I2C2_SDA
*/

/* ?¡§¨°?I2C¡Á¨¹??¨¢??¨®¦Ì?GPIO???¨², ¨®??¡ì??D¨¨¨°aDT??????4DD¡ä¨²???¡ä?¨¦¨¨?¨°a??¡À?SCLo¨ªSDA¦Ì?¨°y?? */


/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: bsp_InitI2C
*	1|?¨¹?¦Ì?¡Â: ????I2C¡Á¨¹??¦Ì?GPIO¡ê?2¨¦¨®??¡ê?aIO¦Ì?¡¤?¨º?¨º¦Ì??
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ?T
*********************************************************************************************************
*/
void bsp_InitI2C(void)
{
//	GPIO_InitTypeDef GPIO_InitStructure;
//
//	RCC_AHB1PeriphClockCmd(RCC_I2C_PORT, ENABLE);	/* ¡ä¨°?aGPIO¨º¡À?¨® */
//
//	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;		/* ¨¦¨¨?a¨º?3??¨² */
//	GPIO_InitStructure.GPIO_OType = GPIO_OType_OD;		/* ¨¦¨¨?a?a???¡ê¨º? */
//	GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;	/* ¨¦???¨¤-¦Ì?¡Á¨¨2?¨º1?¨¹ */
//	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;	/* IO?¨²¡Á?¡ä¨®?¨´?¨¨ */
//	GPIO_InitStructure.GPIO_Pin = I2C_SCL_PIN | I2C_SDA_PIN;
//	GPIO_Init(GPIO_PORT_I2C, &GPIO_InitStructure);
//      GPIO_Init(GPIOA, GPIO_PIN_3, GPIO_MODE_OUT_PP_LOW_FAST)
   GPIO_Init(GPIO_PORT_I2C, I2C_SCL_PIN, GPIO_MODE_OUT_PP_HIGH_FAST);
   GPIO_Init(GPIO_PORT_I2C, I2C_SDA_PIN, GPIO_MODE_OUT_PP_HIGH_FAST);
	/* ??¨°???¨ª¡ê?1D?o?, ?¡ä??I2C¡Á¨¹??¨¦?¦Ì??¨´¨®D¨¦¨¨¡À?¦Ì?¡äy?¨²?¡ê¨º? */
   i2c_Stop();
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_Delay
*	1|?¨¹?¦Ì?¡Â: I2C¡Á¨¹?????¨®3¨´¡ê?¡Á??¨¬400KHz
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ?T
*********************************************************************************************************
*/
static void i2c_Delay(void)
{
	uint8_t i;

	/*??
		CPU?¡Â?¦Ì168MHz¨º¡À¡ê??¨²?¨²2?Flash??DD, MDK1¡è3¨¬2?¨®??¡¥?¡ê¨®?¨¬¡§¨º?¨º?2¡§?¡Â1?2a2¡§D??¡ê
		?-?¡¤¡ä?¨ºy?a5¨º¡À¡ê?SCL?¦Ì?¨º = 1.78MHz (?¨¢o?¨º¡À: 92ms, ?¨¢D¡ä?y3¡ê¡ê?¦Ì?¨º?¨®?¨º?2¡§?¡Â¨¬?¨ª¡¤??¨¦??¨ª?¨¢D¡ä¨º¡ì¡ã¨¹?¡ê¨º¡ÀD¨°?¨®?¨¹¨¢¨´??)
		?-?¡¤¡ä?¨ºy?a10¨º¡À¡ê?SCL?¦Ì?¨º = 1.1MHz (?¨¢o?¨º¡À: 138ms, ?¨¢?¨´?¨¨: 118724B/s)
		?-?¡¤¡ä?¨ºy?a30¨º¡À¡ê?SCL?¦Ì?¨º = 440KHz¡ê? SCL??¦Ì???¨º¡À??1.0us¡ê?SCL¦Ì¨ª¦Ì???¨º¡À??1.2us

		¨¦?¨¤-¦Ì?¡Á¨¨????2.2K?¡¤¨º¡À¡ê?SCL¨¦?¨¦y??¨º¡À????0.5us¡ê?¨¨?1???4.7K?¡¤¡ê??¨°¨¦?¨¦y????1us

		¨º¦Ì?¨º¨®|¨®?????400KHz¡Á¨®¨®¨°¦Ì??¨´?¨º?¡ä?¨¦
	*/
	for (i = 0; i < 30; i++);
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_Start
*	1|?¨¹?¦Ì?¡Â: CPU¡¤¡é?eI2C¡Á¨¹?????¡¥D?o?
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ?T
*********************************************************************************************************
*/
void i2c_Start(void)
{
	/* ¦Ì¡ÀSCL??¦Ì???¨º¡À¡ê?SDA3???¨°?????¨¬???¡À¨ª¨º?I2C¡Á¨¹?????¡¥D?o? */
	I2C_SDA_1();
	I2C_SCL_1();
	i2c_Delay();
	I2C_SDA_0();
	i2c_Delay();
	I2C_SCL_0();
	i2c_Delay();
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_Start
*	1|?¨¹?¦Ì?¡Â: CPU¡¤¡é?eI2C¡Á¨¹??¨ª¡ê?1D?o?
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ?T
*********************************************************************************************************
*/
void i2c_Stop(void)
{
	/* ¦Ì¡ÀSCL??¦Ì???¨º¡À¡ê?SDA3???¨°???¨¦?¨¬???¡À¨ª¨º?I2C¡Á¨¹??¨ª¡ê?1D?o? */
	I2C_SDA_0();
	I2C_SCL_1();
	i2c_Delay();
	I2C_SDA_1();
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_SendByte
*	1|?¨¹?¦Ì?¡Â: CPU?¨°I2C¡Á¨¹??¨¦¨¨¡À?¡¤¡é?¨ª8bit¨ºy?Y
*	D?    2?:  _ucByte ¡êo ¦Ì¨¨¡äy¡¤¡é?¨ª¦Ì?¡Á??¨²
*	¡¤¦Ì ?? ?¦Ì: ?T
*********************************************************************************************************
*/
void i2c_SendByte(uint8_t _ucByte)
{
	uint8_t i;

	/* ?¨¨¡¤¡é?¨ª¡Á??¨²¦Ì?????bit7 */
	for (i = 0; i < 8; i++)
	{
		if (_ucByte & 0x80)
		{
			I2C_SDA_1();
		}
		else
		{
			I2C_SDA_0();
		}
		i2c_Delay();
		I2C_SCL_1();
		i2c_Delay();
		I2C_SCL_0();
		if (i == 7)
		{
			 I2C_SDA_1(); // ¨º¨ª¡¤?¡Á¨¹??
		}
		_ucByte <<= 1;	/* ¡Á¨®¨°?¨°???bit */
		i2c_Delay();
	}
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_ReadByte
*	1|?¨¹?¦Ì?¡Â: CPU¡ä¨®I2C¡Á¨¹??¨¦¨¨¡À??¨¢¨¨?8bit¨ºy?Y
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ?¨¢¦Ì?¦Ì?¨ºy?Y
*********************************************************************************************************
*/
uint8_t i2c_ReadByte(void)
{
	uint8_t i;
	uint8_t value;

	/* ?¨¢¦Ì?¦Ì¨²1??bit?a¨ºy?Y¦Ì?bit7 */
	value = 0;
	for (i = 0; i < 8; i++)
	{
		value <<= 1;
		I2C_SCL_1();
		i2c_Delay();
		if (I2C_SDA_READ())
		{
			value++;
		}
		I2C_SCL_0();
		i2c_Delay();
	}
	return value;
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_WaitAck
*	1|?¨¹?¦Ì?¡Â: CPU2¨²¨¦¨²¨°???¨º¡À?¨®¡ê?2¡é?¨¢¨¨??¡Â?t¦Ì?ACK¨®|¡äeD?o?
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ¡¤¦Ì??0¡À¨ª¨º??y¨¨¡¤¨®|¡äe¡ê?1¡À¨ª¨º??T?¡Â?t?¨¬¨®|
*********************************************************************************************************
*/
uint8_t i2c_WaitAck(void)
{
	uint8_t re;

	I2C_SDA_1();	/* CPU¨º¨ª¡¤?SDA¡Á¨¹?? */
	i2c_Delay();
	I2C_SCL_1();	/* CPU?y?¡¥SCL = 1, ¡ä?¨º¡À?¡Â?t?¨¢¡¤¦Ì??ACK¨®|¡äe */
	i2c_Delay();
	if (I2C_SDA_READ())	/* CPU?¨¢¨¨?SDA?¨²??¡Á¡ä¨¬? */
	{
		re = 1;
	}
	else
	{
		re = 0;
	}
	I2C_SCL_0();
	i2c_Delay();
	return re;
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_Ack
*	1|?¨¹?¦Ì?¡Â: CPU2¨²¨¦¨²¨°???ACKD?o?
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ?T
*********************************************************************************************************
*/
void i2c_Ack(void)
{
	I2C_SDA_0();	/* CPU?y?¡¥SDA = 0 */
	i2c_Delay();
	I2C_SCL_1();	/* CPU2¨²¨¦¨²1??¨º¡À?¨® */
	i2c_Delay();
	I2C_SCL_0();
	i2c_Delay();
	I2C_SDA_1();	/* CPU¨º¨ª¡¤?SDA¡Á¨¹?? */
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_NAck
*	1|?¨¹?¦Ì?¡Â: CPU2¨²¨¦¨²1??NACKD?o?
*	D?    2?:  ?T
*	¡¤¦Ì ?? ?¦Ì: ?T
*********************************************************************************************************
*/
void i2c_NAck(void)
{
	I2C_SDA_1();	/* CPU?y?¡¥SDA = 1 */
	i2c_Delay();
	I2C_SCL_1();	/* CPU2¨²¨¦¨²1??¨º¡À?¨® */
	i2c_Delay();
	I2C_SCL_0();
	i2c_Delay();
}

/*
*********************************************************************************************************
*	o¡¥ ¨ºy ??: i2c_CheckDevice
*	1|?¨¹?¦Ì?¡Â: ?¨¬2aI2C¡Á¨¹??¨¦¨¨¡À?¡ê?CPU?¨°¡¤¡é?¨ª¨¦¨¨¡À?¦Ì??¡¤¡ê?¨¨?o¨®?¨¢¨¨?¨¦¨¨¡À?¨®|¡äe¨¤¡ä?D????¨¦¨¨¡À?¨º?¡¤?¡ä??¨²
*	D?    2?:  _Address¡êo¨¦¨¨¡À?¦Ì?I2C¡Á¨¹??¦Ì??¡¤
*	¡¤¦Ì ?? ?¦Ì: ¡¤¦Ì???¦Ì 0 ¡À¨ª¨º??y¨¨¡¤¡ê? ¡¤¦Ì??1¡À¨ª¨º??¡ä¨¬?2a¦Ì?
*********************************************************************************************************
*/
uint8_t i2c_CheckDevice(uint8_t _Address)
{
	uint8_t ucAck;

	if (I2C_SDA_READ() && I2C_SCL_READ())
	{
		i2c_Start();		/* ¡¤¡é?¨ª???¡¥D?o? */

		/* ¡¤¡é?¨ª¨¦¨¨¡À?¦Ì??¡¤+?¨¢D¡ä????bit¡ê¡§0 = w¡ê? 1 = r) bit7 ?¨¨¡ä? */
		i2c_SendByte(_Address | I2C_WR);
		ucAck = i2c_WaitAck();	/* ?¨¬2a¨¦¨¨¡À?¦Ì?ACK¨®|¡äe */

		i2c_Stop();			/* ¡¤¡é?¨ª¨ª¡ê?1D?o? */

		return ucAck;
	}
	return 1;	/* I2C¡Á¨¹??¨°¨¬3¡ê */
}






